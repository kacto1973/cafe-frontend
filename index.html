<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cafe-frontend</title>
    <link href="/src/style.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
  </head>
  <body>
    <style>
      #favorites-list::-webkit-scrollbar {
        display: none;
      }
      #favorites-list {
        -ms-overflow-style: none; /* IE y Edge */
        scrollbar-width: none; /* Firefox */
      }
    </style>
    <!--
      
      INSTRUCCIONES:

      Tienda de caf√© front terminar:
      -responsividad

      -->
    <header
      class="sticky top-0 left-0 right-0 z-50 bg-black text-white flex flex-row p-5 items-center justify-between"
    >
      <h1 class="font-bold text-2xl cursor-pointer p-2">Las 3 Torres</h1>
      <nav class="">
        <ul class="flex flex-row gap-5" id="auth-nav"></ul>
      </nav>
    </header>

    <main class="px-10 relative">
      <section class="p-10 flex flex-col gap-5">
        <article
          class="flex flex-col items-start md:flex-row md:items-center mb-5"
        >
          <h2 class="font-bold text-2xl">Nuestros Productos</h2>
          <input
            id="search-products"
            type="text"
            placeholder="Buscar productos..."
            class="p-2 border border-gray-400 rounded-md w-full mt-2 md:mt-0 md:w-[500px] md:ml-10"
          />
          <select
            class="p-2 border border-gray-400 rounded-md md:ml-10 md:mt-0 mt-4"
            id="sort-select"
          >
            <option value="default">Ordenar por</option>
            <option value="price-asc">Precio: Menor a Mayor</option>
            <option value="price-desc">Precio: Mayor a Menor</option>
            <option value="popularity-desc">Popularidad</option>
          </select>
          <button
            class="md:ml-6 md:mt-0 mt-4 bg-cyan-500 text-white font-bold rounded-md px-4 py-2 transition-colors duration-300 hover:bg-cyan-400"
            id="favorites-button"
          >
            Mis Favoritos
          </button>
        </article>
        <div class="flex flex-row flex-wrap gap-5" id="products-list"></div>
      </section>
      <div class="hidden inset-0 fixed bg-black/60 z-50 pointer-events-none">
        <article
          id="favorites-modal"
          class="bg-white rounded-md p-8 w-[80%] md:w-[700px] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"
        >
          <div>
            <h2 class="font-bold text-lg">Tus Productos Favoritos</h2>
            <span
              id="close-favorites-modal"
              class="p-4 bg-white font-bold text-black cursor-pointer rounded-full absolute right-5 top-5"
              >X</span
            >
          </div>
          <div
            id="favorites-list"
            class="flex flex-row gap-5 mt-5 overflow-x-auto h-[80%]"
          ></div>
        </article>
      </div>
    </main>

    <footer class="bg-black text-white p-10 flex flex-col">
      <p class="font-bold text-lg">Tienda de Caf√© "Las 3 Torres"</p>
      <p class="font-light text-md">
        Blvd. Independencia #1234, Torre√≥n, Coahuila
      </p>
      <p class="font-light text-md">‚òéÔ∏è+52 662 423 7920</p>
    </footer>
    <script type="module">
      import { cafes } from "./js/cafes.js";
      import { usuarios } from "./js/usuarios.js";

      // JS functions

      const renderAuthNav = () => {
        const authNav = document.getElementById("auth-nav");
        authNav.innerHTML = "";
        const loggedIn = localStorage.getItem("loggedUser");

        console.log(loggedIn);

        if (!loggedIn) {
          authNav.innerHTML = `
                          <li
                            id="login-button"
                            class="font-bold text-md p-3 rounded-md hover:bg-white hover:text-black cursor-pointer transition-colors"
                          >
                            Iniciar Sesi√≥n
                          </li>
                          <li
                            class="font-bold text-md p-3 rounded-md hover:bg-white hover:text-black cursor-pointer transition-colors"
                          >
                            Registrarme
                          </li>
                        `;

          document
            .getElementById("login-button")
            .addEventListener("click", () => {
              showLoginModal();
            });
        } else {
          authNav.innerHTML = `

                          <li

                            class="hidden md:block font-bold text-md p-3 rounded-md"
                          >
                            Bienvenido, ${localStorage.getItem("loggedUser")}
                          </li>
                          <li
                            id="cart-button"
                            class="font-bold text-md p-3 rounded-md hover:bg-white hover:text-black cursor-pointer transition-colors"
                          >
                            Carrito üõí
                          </li>
                          <li
                          id="logout-button"
                            class="font-bold text-md p-3 rounded-md hover:bg-white hover:text-black cursor-pointer transition-colors"
                          >
                            Cerrar Sesi√≥n
                          </li>
                        `;

          document
            .getElementById("logout-button")
            .addEventListener("click", () => {
              handleLogout();
            });
        }
      };

      const loadProducts = () => {
        const inputText = document.getElementById("search-products").value;
        console.log("desde load prod: ", inputText);

        const productsContainer = document.getElementById("products-list");

        // LIMPIAR contenedor antes de agregar nuevos productos
        productsContainer.innerHTML = "";

        const productsFragment = document.createDocumentFragment();

        // Si no hay usuario logueado, mostrar todos los productos
        if (!localStorage.getItem("loggedUser")) {
          const filteredCafes = cafes.filter((coffee) =>
            coffee.titulo.toLowerCase().includes(inputText.toLowerCase()),
          );

          const selectValue = document.getElementById("sort-select").value;

          let sortedCafes = filteredCafes;

          switch (selectValue) {
            case "default":
              break;
            case "price-asc":
              sortedCafes = sortedCafes.sort((a, b) => a.precio - b.precio);
              break;
            case "price-desc":
              sortedCafes = sortedCafes.sort((a, b) => b.precio - a.precio);

              break;
            case "popularity-desc":
              break;
          }

          sortedCafes.forEach((coffee) => {
            const newCard = createProductCard(coffee);
            productsFragment.appendChild(newCard);
          });
          productsContainer.appendChild(productsFragment);
          return;
        }

        // Obtener favoritos del usuario actual
        const allFavorites =
          JSON.parse(localStorage.getItem("userFavorites")) || {};
        const currentUserFavorites =
          allFavorites[localStorage.getItem("loggedUser")] || [];

        console.log("current user favorites: ", currentUserFavorites);

        // Filtrar caf√©s que NO est√°n en favoritos
        const cafesNoFavoritos = cafes.filter((coffee) => {
          const esFavorito = currentUserFavorites.some(
            (cafe) => cafe.id === coffee.id,
          );
          return !esFavorito;
        });

        console.log(
          "Caf√©s no favoritos encontrados: ",
          cafesNoFavoritos.length,
        );

        // Mostrar mensaje si no hay productos
        if (cafesNoFavoritos.length === 0) {
          productsContainer.innerHTML = `
              <div class="col-span-3 text-center py-10">
                <p class="text-lg font-semibold">¬°Todos los caf√©s est√°n en tus favoritos!</p>
                <p class="text-gray-600">Prueba remover algunos de favoritos para verlos aqu√≠.</p>
              </div>
            `;
          return;
        }

        const filteredCafes = cafesNoFavoritos.filter((coffee) =>
          coffee.titulo.toLowerCase().includes(inputText.toLowerCase()),
        );

        const selectValue = document.getElementById("sort-select").value;

        let sortedCafes = filteredCafes;

        switch (selectValue) {
          case "default":
            break;
          case "price-asc":
            sortedCafes = sortedCafes.sort((a, b) => a.precio - b.precio);
            break;
          case "price-desc":
            sortedCafes = sortedCafes.sort((a, b) => b.precio - a.precio);

            break;
          case "popularity-desc":
            break;
        }

        // Crear cards para cada caf√© no favorito
        sortedCafes.forEach((coffee) => {
          const newCard = createProductCard(coffee);
          productsFragment.appendChild(newCard);
        });

        productsContainer.appendChild(productsFragment);
      };

      const handleRemoveFavorite = (coffee) => {
        const loggedUser = localStorage.getItem("loggedUser");
        if (!loggedUser) {
          return;
        }

        const userFavorites =
          JSON.parse(localStorage.getItem("userFavorites")) || {};

        // Verificar si el usuario tiene favoritos
        if (!userFavorites[loggedUser]) {
          return;
        }

        // Filtrar Y REASIGNAR al objeto userFavorites
        userFavorites[loggedUser] = userFavorites[loggedUser].filter(
          (element) => element.id !== coffee.id,
        );

        // Ahora s√≠ guardar el objeto actualizado
        localStorage.setItem("userFavorites", JSON.stringify(userFavorites));

        loadProducts();
      };

      const addToFavorites = (coffee) => {
        const loggedUser = localStorage.getItem("loggedUser");
        if (!loggedUser) {
          Toastify({
            text: "¬°A√±adido a favoritos! ‚òï",
            duration: 3000,
            gravity: "bottom",
            position: "right",
            style: {
              background: "#6F4E37",
            },
          }).showToast();
          return;
        }

        const userFavorites =
          JSON.parse(localStorage.getItem("userFavorites")) || {};

        // Inicializar si no existe
        if (!userFavorites[loggedUser]) {
          userFavorites[loggedUser] = [];
        }

        // Verificar si ya existe
        const elementExists = userFavorites[loggedUser].some(
          (element) => element.id === coffee.id,
        );

        if (elementExists) {
          Toastify({
            text: `${coffee.titulo} ya est√° en tus favoritos`,
            duration: 3000,
            gravity: "bottom",
            position: "right",
            style: {
              background: "#6F4E37",
            },
          }).showToast();

          return;
        }

        // Agregar a favoritos
        userFavorites[loggedUser].push(coffee);

        // Guardar en localStorage
        localStorage.setItem("userFavorites", JSON.stringify(userFavorites));

        console.log("Favoritos actualizados:", userFavorites[loggedUser]);

        // Recargar ambas secciones
        loadProducts();

        Toastify({
          text: `${coffee.titulo} ha sido agregado a tus favoritos ‚òï`,
          duration: 3000,
          gravity: "bottom",
          position: "right",
          style: {
            background: "#6F4E37",
          },
        }).showToast();
      };

      const cerrarModal = () => {
        document.body.removeChild(
          document.getElementById("login-modal-overlay"),
        );
        document.body.removeChild(document.getElementById("login-modal"));
      };

      const handleLogout = () => {
        localStorage.removeItem("loggedUser");
        window.location.reload();
      };

      const handleLogin = () => {
        // L√≥gica de autenticaci√≥n simulada
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const foundUser = usuarios.find(
          (usuario) =>
            usuario.username === username && usuario.password === password,
        );

        if (foundUser) {
          localStorage.setItem("loggedUser", foundUser.username);
          Toastify({
            text: "Inicio de sesi√≥n exitoso üéâ",
            duration: 3000,
            gravity: "bottom",
            position: "right",
            style: {
              background: "#6F4E37",
            },
          }).showToast();
          window.location.reload();
        } else {
          Toastify({
            text: "Credenciales incorrectas, int√©ntelo nuevamente",
            duration: 3000,
            gravity: "bottom",
            position: "right",
            style: {
              background: "#6F4E37",
            },
          }).showToast();
        }
      };

      const showLoginModal = () => {
        const overlay = document.createElement("div");
        overlay.className =
          "fixed inset-0 bg-black opacity-50 flex items-center justify-center";
        overlay.id = "login-modal-overlay";

        const modal = document.createElement("div");
        modal.className =
          "w-[300px] bg-white p-5 rounded-md absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col gap-5 justify-center items-center";
        modal.id = "login-modal";

        let contenidoHTML = `
                        <h3 class="text-black font-bold text-lg">Iniciar Sesi√≥n</h3>
                        <span class="absolute top-5 right-5 cursor-pointer font-bold text-lg" id="close-modal">&times;</span>
                        <input id="username" class="w-full p-2 border-1 border-gray-400 rounded-md" type="text" placeholder="Usuario" />
                        <input id="password" class="w-full p-2 border-1 border-gray-400 rounded-md" type="password" placeholder="Contrase√±a" />
                        <button id="login-submit" class="w-full bg-black text-white p-2 rounded-md hover:bg-gray-800 transition-colors duration-300">Ingresar</button>
                      `;

        modal.innerHTML = contenidoHTML;

        document.body.appendChild(overlay);
        document.body.appendChild(modal);

        document
          .getElementById("login-submit")
          .addEventListener("click", () => {
            handleLogin();
          });

        document.getElementById("close-modal").addEventListener("click", () => {
          cerrarModal();
        });
      };

      const loadFavorites = () => {
        const loggedUser = localStorage.getItem("loggedUser");
        if (!loggedUser) {
          Toastify({
            text: "Por favor, inicie sesi√≥n primero",
            duration: 3000,
            gravity: "bottom",
            position: "right",
            style: {
              background: "#6F4E37",
            },
          }).showToast();
          return;
        }

        const userFavorites =
          JSON.parse(localStorage.getItem("userFavorites")) || {};

        const favoritesContainer = document.getElementById("favorites-list");
        favoritesContainer.innerHTML = "";

        if (
          !userFavorites[loggedUser] ||
          userFavorites[loggedUser].length === 0
        ) {
          favoritesContainer.innerHTML = `
                  <div class="col-span-3 text-center py-10">
                    <p class="text-lg font-semibold">¬°No tienes caf√©s favoritos a√∫n!</p>
                    <p class="text-gray-600">Explora nuestros productos y agr√©galos a tus favoritos.</p>
                  </div>
                `;
          return;
        }

        const favoritesFragment = document.createDocumentFragment();

        userFavorites[loggedUser].forEach((coffee) => {
          const favoriteCard = createFavoriteCard(coffee);
          favoritesFragment.appendChild(favoriteCard);
        });

        favoritesContainer.appendChild(favoritesFragment);
      };

      const createFavoriteCard = (coffee) => {
        const card = document.createElement("article");
        card.className =
          "relative flex flex-col mt-4 rounded-md min-w-[300px] overflow-hidden border-1 border-gray-400 transition-transform duration-300 hover:translate-y-[-5px] ";
        card.innerHTML = `
        <img class="w-full h-[200px] object-cover transition-transform hover:scale-105 duration-500" src="${coffee.imagen}" alt="${coffee.titulo}" />

        <!-- Coraz√≥n como bot√≥n de remover (reemplaza al bot√≥n rosa) -->
        <img id="remove-favorite-button" class="absolute right-4 top-4 bg-white p-1 rounded-full cursor-pointer transition-transform duration-300 hover:translate-y-[-3px] hover:bg-red-100" width="30" src="assets/heart-svgrepo-com.svg" alt="Remover de favoritos">

        <div class="relative flex flex-col p-5 gap-3">
          <span class="absolute right-4 top-4 text-amber-700 font-bold">$${coffee.precio}</span>
          <h3 class="font-bold text-xl">${coffee.titulo}</h3>
          <p class="text-gray-500">${coffee.descripcion}</p>
          <span class="text-yellow-400 absolute right-4 top-12">‚≠ê ${coffee.popularidad}</span>

          <!-- Bot√≥n de ordenar a todo lo ancho -->
          <button class="w-full mt-2 bg-black text-white p-2 rounded-md hover:bg-gray-800 transition-colors duration-300 cursor-pointer">Agregar al Carrito</button>
        </div>
      `;

        const removeButton = card.querySelector("#remove-favorite-button");
        removeButton.addEventListener("click", () => {
          handleRemoveFavorite(coffee);
          loadFavorites();
        });

        return card;
      };

      const createProductCard = (coffee) => {
        const card = document.createElement("article");
        card.className =
          "relative flex flex-col mt-4 rounded-md w-[300px] overflow-hidden border-1 border-gray-400 transition-transform duration-300 hover:translate-y-[-5px] ";
        card.innerHTML = `
                        <img class="w-full h-[200px] object-cover transition-transform hover:scale-105 duration-500" src="${coffee.imagen}" alt="${coffee.titulo}" />
                        <img id="favorite-button" class="absolute right-4 top-4 bg-white p-1 rounded-full cursor-pointer transition-transform duration-300 hover:translate-y-[-3px] " width="30" src="assets/heart-svgrepo-com.svg" alt="Favorito">

                        <div class="relative flex flex-col p-5 gap-3">
                          <span class="absolute right-4 top-4 text-amber-700 font-bold">$${coffee.precio}</span>
                          <h3 class="font-bold text-xl">${coffee.titulo}</h3>
                          <p class="text-gray-500">${coffee.descripcion}</p>
                            <button class="mt-2 bg-black text-white p-2 rounded-md hover:bg-gray-800 transition-colors duration-300 cursor-pointer">Agregar al Carrito</button>
                          <span class="text-yellow-400 absolute right-4 top-12">‚≠ê ${coffee.popularidad}</span>
                        </div>
                    `;

        const favoriteButton = card.querySelector("#favorite-button");
        favoriteButton.addEventListener("click", () => {
          const loggedUser = localStorage.getItem("loggedUser");
          if (!loggedUser) {
            Toastify({
              text: "Por favor, inicie sesi√≥n para a√±adir a favoritos! ‚òï",
              duration: 3000,
              gravity: "bottom",
              position: "right",
              style: {
                background: "#6F4E37",
              },
            }).showToast();
            return;
          }
          addToFavorites(coffee);
        });

        return card;
      };

      // JS functions

      //////////////// Cargar productos

      loadProducts();
      loadFavorites();

      renderAuthNav();

      document
        .getElementById("search-products")
        .addEventListener("input", loadProducts);

      document
        .getElementById("sort-select")
        .addEventListener("change", loadProducts);

      document
        .getElementById("favorites-button")
        .addEventListener("click", () => {
          const loggedUser = localStorage.getItem("loggedUser");
          if (!loggedUser) {
            Toastify({
              text: "Por favor, inicie sesi√≥n primero",
              duration: 3000,
              gravity: "bottom",
              position: "right",
              style: {
                background: "#6F4E37",
              },
            }).showToast();
            return;
          }

          const modalOverlay = document.querySelector(
            ".inset-0.fixed.bg-black\\/60.z-50.pointer-events-none",
          );
          modalOverlay.classList.remove("pointer-events-none", "hidden");
          loadFavorites();
        });

      document
        .getElementById("close-favorites-modal")
        .addEventListener("click", () => {
          const modalOverlay = document.querySelector(
            ".inset-0.fixed.bg-black\\/60.z-50",
          );
          modalOverlay.classList.add("pointer-events-none", "hidden");
        });
    </script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
  </body>
</html>
