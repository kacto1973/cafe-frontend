<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cafe-frontend</title>
    <link href="/src/style.css" rel="stylesheet" />
  </head>
  <body>
    <style>
      #favorites-list::-webkit-scrollbar {
        display: none;
      }
      #favorites-list {
        -ms-overflow-style: none; /* IE y Edge */
        scrollbar-width: none; /* Firefox */
      }
    </style>
    <!--
    
    INSTRUCCIONES:

    Tienda de café front terminar:
    -meterle cuentas
    -popularidad
    -agregar al carrito
    -toasts
    -responsividad

    ***Mandar msd tardar mañana 9:30 am repo y lo que hayamos avanzado

    -->
    <header
      class="bg-black text-white flex flex-row p-5 items-center justify-between"
    >
      <h1 class="font-bold text-2xl cursor-pointer p-2">
        Tienda de Café "Las 3 Torres"
      </h1>
      <nav>
        <ul class="flex flex-row gap-5" id="auth-nav"></ul>
      </nav>
    </header>

    <section class="p-10 flex flex-col gap-5">
      <h2 class="font-bold text-2xl">Tus Productos Favoritos</h2>
      <div
        class="flex flex-row gap-10 overflow-x-auto overflow-y-hidden"
        id="favorites-list"
      ></div>
    </section>
    <section class="p-10 flex flex-col gap-5">
      <div class="flex flex-row items-center mb-5">
        <h2 class="font-bold text-2xl">Nuestros Productos</h2>
        <input
          id="search-products"
          type="text"
          placeholder="Buscar productos..."
          class="p-2 border border-gray-400 rounded-md w-[500px] ml-10"
        />
        <select
          class="p-2 border border-gray-400 rounded-md ml-10"
          id="sort-select"
        >
          <option value="default">Ordenar por</option>
          <option value="price-asc">Precio: Menor a Mayor</option>
          <option value="price-desc">Precio: Mayor a Menor</option>
          <option value="popularity-desc">Popularidad</option>
        </select>
      </div>
      <div class="grid grid-cols-3 gap-5" id="products-list"></div>
    </section>
    <footer class="bg-black text-white p-10 flex flex-col">
      <p class="font-bold text-lg">Tienda de Café "Las 3 Torres"</p>
      <p class="font-light text-md">
        Blvd. Independencia #1234, Torreón, Coahuila
      </p>
      <p class="font-light text-md">☎️+52 662 423 7920</p>
    </footer>
    <script type="module">
      import { cafes } from "./js/cafes.js";
      import { usuarios } from "./js/usuarios.js";

      // JS functions

      const renderAuthNav = () => {
        const authNav = document.getElementById("auth-nav");
        authNav.innerHTML = "";
        const loggedIn = localStorage.getItem("loggedUser");

        console.log(loggedIn);

        if (!loggedIn) {
          authNav.innerHTML = `
                    <li
                      id="login-button"
                      class="font-bold text-md p-3 rounded-md hover:bg-white hover:text-black cursor-pointer transition-colors"
                    >
                      Iniciar Sesión
                    </li>
                    <li
                      class="font-bold text-md p-3 rounded-md hover:bg-white hover:text-black cursor-pointer transition-colors"
                    >
                      Registrarme
                    </li>
                  `;

          document
            .getElementById("login-button")
            .addEventListener("click", () => {
              showLoginModal();
            });
        } else {
          authNav.innerHTML = `
                    <li

                      class="font-bold text-md p-3 rounded-md"
                    >
                      Bienvenido, ${localStorage.getItem("loggedUser")}
                    </li>
                    <li
                    id="logout-button"
                      class="font-bold text-md p-3 rounded-md hover:bg-white hover:text-black cursor-pointer transition-colors"
                    >
                      Cerrar Sesión
                    </li>
                  `;

          document
            .getElementById("logout-button")
            .addEventListener("click", () => {
              handleLogout();
            });
        }
      };

      const loadProducts = () => {
        const inputText = document.getElementById("search-products").value;
        console.log("desde load prod: ", inputText);

        const productsContainer = document.getElementById("products-list");

        // LIMPIAR contenedor antes de agregar nuevos productos
        productsContainer.innerHTML = "";

        const productsFragment = document.createDocumentFragment();

        // Si no hay usuario logueado, mostrar todos los productos
        if (!localStorage.getItem("loggedUser")) {
          const filteredCafes = cafes.filter((coffee) =>
            coffee.titulo.toLowerCase().includes(inputText.toLowerCase()),
          );

          const selectValue = document.getElementById("sort-select").value;

          let sortedCafes = filteredCafes;

          switch (selectValue) {
            case "default":
              break;
            case "price-asc":
              sortedCafes = sortedCafes.sort((a, b) => a.precio - b.precio);
              break;
            case "price-desc":
              sortedCafes = sortedCafes.sort((a, b) => b.precio - a.precio);

              break;
            case "popularity-desc":
              break;
          }

          sortedCafes.forEach((coffee) => {
            const newCard = createProductCard(coffee);
            productsFragment.appendChild(newCard);
          });
          productsContainer.appendChild(productsFragment);
          return;
        }

        // Obtener favoritos del usuario actual
        const allFavorites =
          JSON.parse(localStorage.getItem("userFavorites")) || {};
        const currentUserFavorites =
          allFavorites[localStorage.getItem("loggedUser")] || [];

        console.log("current user favorites: ", currentUserFavorites);

        // Filtrar cafés que NO están en favoritos
        const cafesNoFavoritos = cafes.filter((coffee) => {
          const esFavorito = currentUserFavorites.some(
            (cafe) => cafe.id === coffee.id,
          );
          return !esFavorito;
        });

        console.log(
          "Cafés no favoritos encontrados: ",
          cafesNoFavoritos.length,
        );

        // Mostrar mensaje si no hay productos
        if (cafesNoFavoritos.length === 0) {
          productsContainer.innerHTML = `
        <div class="col-span-3 text-center py-10">
          <p class="text-lg font-semibold">¡Todos los cafés están en tus favoritos!</p>
          <p class="text-gray-600">Prueba remover algunos de favoritos para verlos aquí.</p>
        </div>
      `;
          return;
        }

        const filteredCafes = cafesNoFavoritos.filter((coffee) =>
          coffee.titulo.toLowerCase().includes(inputText.toLowerCase()),
        );

        const selectValue = document.getElementById("sort-select").value;

        let sortedCafes = filteredCafes;

        switch (selectValue) {
          case "default":
            break;
          case "price-asc":
            sortedCafes = sortedCafes.sort((a, b) => a.precio - b.precio);
            break;
          case "price-desc":
            sortedCafes = sortedCafes.sort((a, b) => b.precio - a.precio);

            break;
          case "popularity-desc":
            break;
        }

        // Crear cards para cada café no favorito
        sortedCafes.forEach((coffee) => {
          const newCard = createProductCard(coffee);
          productsFragment.appendChild(newCard);
        });

        productsContainer.appendChild(productsFragment);
      };

      const loadFavorites = () => {
        const favoritesContainer = document.getElementById("favorites-list");

        // LIMPIAR contenedor antes de agregar nuevos favoritos
        favoritesContainer.innerHTML = "";

        const favoritesFragment = document.createDocumentFragment();

        const loggedUser = localStorage.getItem("loggedUser");

        if (!loggedUser) {
          favoritesContainer.innerHTML = `
        <p class="font-light text-md p-4">Inicia Sesión antes para poder ver tus favoritos :)</p>
      `;
          return;
        }

        const userFavorites =
          JSON.parse(localStorage.getItem("userFavorites")) || {};
        const currentFavorites = userFavorites[loggedUser] || [];

        console.log("current favorites desde loadFavs: ", currentFavorites);

        if (currentFavorites.length > 0) {
          currentFavorites.forEach((coffee) => {
            const newCard = createFavoriteCard(coffee);
            favoritesFragment.appendChild(newCard);
          });
          favoritesContainer.appendChild(favoritesFragment);
        } else {
          favoritesContainer.innerHTML = `
        <p class="font-light text-md p-4">Sin productos favoritos aún. Agrega algunos desde la sección de productos.</p>
      `;
        }
      };

      const handleRemoveFavorite = (coffee) => {
        const loggedUser = localStorage.getItem("loggedUser");
        if (!loggedUser) {
          return;
        }

        const userFavorites =
          JSON.parse(localStorage.getItem("userFavorites")) || {};

        // Verificar si el usuario tiene favoritos
        if (!userFavorites[loggedUser]) {
          return;
        }

        // Filtrar Y REASIGNAR al objeto userFavorites
        userFavorites[loggedUser] = userFavorites[loggedUser].filter(
          (element) => element.id !== coffee.id,
        );

        // Ahora sí guardar el objeto actualizado
        localStorage.setItem("userFavorites", JSON.stringify(userFavorites));

        // Recargar favoritos
        loadFavorites();
        loadProducts();
      };

      const addToFavorites = (coffee) => {
        const loggedUser = localStorage.getItem("loggedUser");
        if (!loggedUser) {
          alert("Por favor, inicie sesión primero");
          return;
        }

        const userFavorites =
          JSON.parse(localStorage.getItem("userFavorites")) || {};

        // Inicializar si no existe
        if (!userFavorites[loggedUser]) {
          userFavorites[loggedUser] = [];
        }

        // Verificar si ya existe
        const elementExists = userFavorites[loggedUser].some(
          (element) => element.id === coffee.id,
        );

        if (elementExists) {
          alert(`${coffee.titulo} ya está en tus favoritos`);
          return;
        }

        // Agregar a favoritos
        userFavorites[loggedUser].push(coffee);

        // Guardar en localStorage
        localStorage.setItem("userFavorites", JSON.stringify(userFavorites));

        console.log("Favoritos actualizados:", userFavorites[loggedUser]);

        // Recargar ambas secciones
        loadFavorites();
        loadProducts();

        alert(`${coffee.titulo} ha sido agregado a tus favoritos.`);
      };

      const cerrarModal = () => {
        document.body.removeChild(
          document.getElementById("login-modal-overlay"),
        );
        document.body.removeChild(document.getElementById("login-modal"));
      };

      const handleLogout = () => {
        localStorage.removeItem("loggedUser");
        window.location.reload();
      };

      const handleLogin = () => {
        // Lógica de autenticación simulada
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const foundUser = usuarios.find(
          (usuario) =>
            usuario.username === username && usuario.password === password,
        );

        if (foundUser) {
          localStorage.setItem("loggedUser", foundUser.username);
          alert("Inicio de sesión exitoso");
          window.location.reload();
        } else {
          alert("Credenciales incorrectas, inténtelo nuevamente");
        }
      };

      const showLoginModal = () => {
        const overlay = document.createElement("div");
        overlay.className =
          "fixed inset-0 bg-black opacity-50 flex items-center justify-center";
        overlay.id = "login-modal-overlay";

        const modal = document.createElement("div");
        modal.className =
          "w-[300px] bg-white p-5 rounded-md absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col gap-5 justify-center items-center";
        modal.id = "login-modal";

        let contenidoHTML = `
                  <h3 class="text-black font-bold text-lg">Iniciar Sesión</h3>
                  <span class="absolute top-5 right-5 cursor-pointer font-bold text-lg" id="close-modal">&times;</span>
                  <input id="username" class="w-full p-2 border-1 border-gray-400 rounded-md" type="text" placeholder="Usuario" />
                  <input id="password" class="w-full p-2 border-1 border-gray-400 rounded-md" type="password" placeholder="Contraseña" />
                  <button id="login-submit" class="w-full bg-black text-white p-2 rounded-md hover:bg-gray-800 transition-colors duration-300">Ingresar</button>
                `;

        modal.innerHTML = contenidoHTML;

        document.body.appendChild(overlay);
        document.body.appendChild(modal);

        document
          .getElementById("login-submit")
          .addEventListener("click", () => {
            handleLogin();
          });

        document.getElementById("close-modal").addEventListener("click", () => {
          cerrarModal();
        });
      };

      const createFavoriteCard = (coffee) => {
        const card = document.createElement("article");
        card.className =
          "flex flex-col gap-2 rounded-md min-w-[400px] max-w-[400px] overflow-hidden border-1 border-gray-400 transition-transform duration-300 hover:translate-y-[-5px] ";
        card.innerHTML = `
                  <img class="w-full h-[200px] object-cover transition-transform hover:scale-105 duration-500" src="${coffee.imagen}" alt="${coffee.titulo}" />

                  <div class="flex flex-col p-5 gap-3">
                    <h3 class="font-bold text-xl">${coffee.titulo} - <span class="text-green-500">$${coffee.precio}</span></h3>
                    <p class="text-md">${coffee.descripcion}</p>
                    <div class="flex flex-row pt-4">
                      <button id="remove-favorite-button" class="bg-red-400 text-white p-2 rounded-md hover:bg-red-500 transition-colors duration-300 mr-2 cursor-pointer">Remover</button>
                      <button class="ml-2 bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition-colors duration-300 cursor-pointer">Ordenar</button>
                    </div>
                  </div>
               `;

        const removeButton = card.querySelector("#remove-favorite-button");
        removeButton.addEventListener("click", () => {
          handleRemoveFavorite(coffee);
        });

        return card;
      };

      const createProductCard = (coffee) => {
        const card = document.createElement("article");
        card.className =
          "flex flex-col rounded-md min-w-[400px] overflow-hidden border-1 border-gray-400 transition-transform duration-300 hover:translate-y-[-5px] ";
        card.innerHTML = `
                  <img class="w-full h-[200px] object-cover transition-transform hover:scale-105 duration-500" src="${coffee.imagen}" alt="${coffee.titulo}" />

                  <div class="relative flex flex-col p-5 gap-3">
                    <h3 class="font-bold text-xl">${coffee.titulo} - <span class="text-green-500">$${coffee.precio}</span></h3>
                    <p class="text-md">${coffee.descripcion}</p>
                    <div class="flex flex-row pt-4">
                      <button id="favorite-button" class="bg-yellow-400 text-white p-2 rounded-md hover:bg-yellow-500 transition-colors duration-300 mr-2 cursor-pointer">Favorito</button>
                      <button class="ml-2 bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition-colors duration-300 cursor-pointer">Ordenar</button>
                    </div>
                    <span class="font-bold absolute right-5 bottom-5 px-4 py-2 border border-2 border-gray-300 rounded-full">⭐ ${coffee.popularidad}</span>
                  </div>
               `;

        const favoriteButton = card.querySelector("#favorite-button");
        favoriteButton.addEventListener("click", () => {
          addToFavorites(coffee);
        });

        return card;
      };

      // JS functions

      //////////////// Productos favoritos

      loadFavorites();

      //////////////// Cargar productos

      loadProducts();

      renderAuthNav();

      document
        .getElementById("search-products")
        .addEventListener("input", loadProducts);

      document
        .getElementById("sort-select")
        .addEventListener("change", loadProducts);
    </script>
  </body>
</html>
